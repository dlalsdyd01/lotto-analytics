{% extends "base.html" %}

{% block title %}Lotto Lab - ë¡œë˜ ë²ˆí˜¸ í†µê³„ ë¶„ì„{% endblock %}
{% block description %}ë¡œë˜ 6/45 ì—­ëŒ€ ë‹¹ì²¨ë²ˆí˜¸ í†µê³„ ë¶„ì„. ë²ˆí˜¸ ì¶œí˜„ ë¹ˆë„, í™€ì§ ë¹„ìœ¨, êµ¬ê°„ ë¶„ì„, íšŒì°¨ë³„ ìƒì„¸ ë¶„ì„ ì œê³µ.{% endblock %}
{% block og_title %}Lotto Lab - ë¡œë˜ ë²ˆí˜¸ í†µê³„ ë¶„ì„{% endblock %}
{% block og_desc %}ë¡œë˜ 6/45 ì—­ëŒ€ ë‹¹ì²¨ë²ˆí˜¸ í†µê³„ ë¶„ì„. ë²ˆí˜¸ ì¶œí˜„ ë¹ˆë„, í™€ì§ ë¹„ìœ¨, êµ¬ê°„ ë¶„ì„ ì œê³µ.{% endblock %}
{% block tw_title %}Lotto Lab - ë¡œë˜ ë²ˆí˜¸ í†µê³„ ë¶„ì„{% endblock %}
{% block tw_desc %}ë¡œë˜ 6/45 ì—­ëŒ€ ë‹¹ì²¨ë²ˆí˜¸ í†µê³„ ë¶„ì„{% endblock %}

{% block head_extra %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.0/kakao.min.js" integrity="sha384-l+xbElFSnPZ2rOaPrU//2FF5B4LB8FiX5q4fXYTlfcG4PGpMkE1vcL7kNXI6Cci0" crossorigin="anonymous"></script>
{% endblock %}

{% block header %}
<header class="header">
    <div class="header-inner">
        <span class="logo">Lotto Lab</span>
        <div class="header-actions">
            <button class="dark-toggle" onclick="toggleDark()" aria-label="ë‹¤í¬ëª¨ë“œ ì „í™˜">&#9790;</button>
            <button class="header-btn" onclick="refreshData(event)">ë°ì´í„° ê°±ì‹ </button>
        </div>
    </div>
</header>
{% endblock %}

{% block body %}
<div class="tab-bar-wrap">
    <div class="tab-bar">
        <button class="tab-item active" data-tab="checker">ë‹¹ì²¨í™•ì¸</button>
        <button class="tab-item" data-tab="history">ë‹¹ì²¨ë²ˆí˜¸</button>
        <button class="tab-item" data-tab="stats">í†µê³„</button>
        <button class="tab-item" data-tab="prediction">ì¶”ì²œë²ˆí˜¸</button>
        <button class="tab-item" data-tab="stores">íŒë§¤ì </button>
        <button class="tab-item" data-tab="probability">í™•ë¥  êµì‹¤</button>
    </div>
</div>

<div class="layout-wrapper">
    <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” ê´‘ê³  -->
    <aside class="sidebar-ad sidebar-ad-left">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-3398247421662455"
             data-ad-slot="LEFT_AD_SLOT"
             data-ad-format="vertical"
             data-full-width-responsive="false"></ins>
        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
    </aside>

    <div class="container">

    <div id="loading" class="loading">
        <div class="spinner"></div>
        <div class="loading-text">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</div>
    </div>

    <!-- ë‹¹ì²¨í™•ì¸ -->
    <div id="tab-checker" class="tab-content">
        <div class="checker-hero fade-in">
            <div class="checker-latest" id="checker-latest-info"></div>
            <div class="checker-title">ë‚´ ë²ˆí˜¸ í™•ì¸í•˜ê¸°</div>
            <div class="checker-subtitle">ë²ˆí˜¸ 6ê°œë¥¼ ì…ë ¥í•˜ê³  ìµœì‹  íšŒì°¨ ë‹¹ì²¨ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ì„¸ìš”</div>

            <div class="checker-input-wrap">
                <div class="checker-balls-input" id="checker-balls">
                    <input type="number" class="checker-num" min="1" max="45" placeholder="?" id="cn1">
                    <input type="number" class="checker-num" min="1" max="45" placeholder="?" id="cn2">
                    <input type="number" class="checker-num" min="1" max="45" placeholder="?" id="cn3">
                    <input type="number" class="checker-num" min="1" max="45" placeholder="?" id="cn4">
                    <input type="number" class="checker-num" min="1" max="45" placeholder="?" id="cn5">
                    <input type="number" class="checker-num" min="1" max="45" placeholder="?" id="cn6">
                </div>
                <div class="checker-actions">
                    <button class="checker-btn" onclick="checkMyNumbers()">ë‹¹ì²¨ í™•ì¸</button>
                    <button class="checker-quick-btn" onclick="clearChecker()">ì´ˆê¸°í™”</button>
                </div>
            </div>
        </div>

        <div id="checker-result" class="fade-in" style="display:none;">
            <div class="checker-result-card" id="checker-summary"></div>
        </div>

        <!-- ì‹œë®¬ë ˆì´í„° (ë‹¹ì²¨í™•ì¸ ë‚´ë¶€) -->
        <div class="sim-hero fade-in" style="margin-top:24px;">
            <div class="sim-title">ë²ˆí˜¸ ì¡°í•© ì‹œë®¬ë ˆì´í„°</div>
            <div class="sim-subtitle">ë‚´ ë²ˆí˜¸ë¡œ ì—­ëŒ€ ì „ íšŒì°¨ë¥¼ ëŒë ¤ë³´ì„¸ìš”</div>

            <div class="sim-input-wrap">
                <div class="sim-balls-input">
                    <input type="number" class="sim-num" min="1" max="45" placeholder="?" id="sn1">
                    <input type="number" class="sim-num" min="1" max="45" placeholder="?" id="sn2">
                    <input type="number" class="sim-num" min="1" max="45" placeholder="?" id="sn3">
                    <input type="number" class="sim-num" min="1" max="45" placeholder="?" id="sn4">
                    <input type="number" class="sim-num" min="1" max="45" placeholder="?" id="sn5">
                    <input type="number" class="sim-num" min="1" max="45" placeholder="?" id="sn6">
                </div>
                <div class="sim-actions">
                    <button class="sim-btn" onclick="runSimulation()">ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘</button>
                    <button class="sim-quick-btn" onclick="randomSimNums()">ëœë¤</button>
                    <button class="sim-quick-btn" onclick="clearSim()">ì´ˆê¸°í™”</button>
                </div>
            </div>
        </div>

        <div id="sim-result" class="fade-in" style="display:none;">
            <div class="g2 fade-in">
                <div class="card">
                    <div class="card-header">ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼</div>
                    <div id="sim-summary" class="stat-block"></div>
                </div>
                <div class="card">
                    <div class="card-header">ìˆ˜ìµë¥ </div>
                    <div id="sim-profit" class="stat-block"></div>
                </div>
            </div>
            <div class="card fade-in">
                <div class="card-header">ë“±ìˆ˜ë³„ ë‹¹ì²¨ íšŸìˆ˜</div>
                <div id="sim-rank-chart" class="sim-rank-bars"></div>
            </div>
            <div class="card fade-in">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
                    <div class="card-header" style="margin-bottom:0;">ë‹¹ì²¨ ë‚´ì—­</div>
                    <span id="sim-match-count" style="font-size:13px;color:var(--text-2);"></span>
                </div>
                <div style="overflow-x:auto;">
                    <table class="tbl" id="sim-table">
                        <thead>
                            <tr>
                                <th>íšŒì°¨</th>
                                <th>ì¶”ì²¨ì¼</th>
                                <th>ë‹¹ì²¨ë²ˆí˜¸</th>
                                <th>ì¼ì¹˜</th>
                                <th>ë“±ìˆ˜</th>
                            </tr>
                        </thead>
                        <tbody id="sim-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ë‹¹ì²¨ë²ˆí˜¸ -->
    <div id="tab-history" class="tab-content">
        <div class="card fade-in">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
                <div class="card-header" style="margin-bottom:0;">ì—­ëŒ€ ë‹¹ì²¨ë²ˆí˜¸</div>
                <input type="text" class="search" id="search-draw" placeholder="íšŒì°¨ ê²€ìƒ‰" oninput="searchDraws()">
            </div>
            <div style="overflow-x:auto;">
                <table class="tbl">
                    <thead>
                        <tr>
                            <th>íšŒì°¨</th>
                            <th>ì¶”ì²¨ì¼</th>
                            <th>ë‹¹ì²¨ë²ˆí˜¸</th>
                            <th>ë³´ë„ˆìŠ¤</th>
                            <th>1ë“± ë‹¹ì²¨ê¸ˆ</th>
                        </tr>
                    </thead>
                    <tbody id="draws-tbody"></tbody>
                </table>
            </div>
            <div id="pagination" class="pager"></div>
        </div>
    </div>

    <!-- í†µê³„ -->
    <div id="tab-stats" class="tab-content">
        <div class="g2 fade-in">
            <div class="card">
                <div class="card-header">ìì£¼ ë‚˜ì˜¨ ë²ˆí˜¸</div>
                <div id="hot-numbers" class="num-grid"></div>
            </div>
            <div class="card">
                <div class="card-header">ì ê²Œ ë‚˜ì˜¨ ë²ˆí˜¸</div>
                <div id="cold-numbers" class="num-grid"></div>
            </div>
        </div>

        <div class="card fade-in">
            <div class="card-header">ìµœê·¼ 50íšŒ ì¶œí˜„ ë¹ˆë„</div>
            <div class="chart-wrap"><canvas id="recentFreqChart"></canvas></div>
        </div>

        <div class="g2 fade-in">
            <div class="card">
                <div class="card-header">êµ¬ê°„ë³„ ë¹„ìœ¨</div>
                <div class="chart-wrap" style="height:260px;"><canvas id="rangeChart"></canvas></div>
            </div>
            <div class="card">
                <div class="card-header">í™€ì§ ë¶„ì„</div>
                <div id="odd-even-stats"></div>
            </div>
        </div>

        <div class="g2 fade-in">
            <div class="card">
                <div class="card-header">ì—°ì†ë²ˆí˜¸</div>
                <div id="consecutive-stats"></div>
            </div>
            <div class="card">
                <div class="card-header">ë²ˆí˜¸ í•©ê³„</div>
                <div id="sum-stats"></div>
            </div>
        </div>

    </div>

    <!-- ì˜ˆì¸¡ -->
    <div id="tab-prediction" class="tab-content">
        <div class="pred-card fade-in">
            <div class="card-header">í†µê³„ ê¸°ë°˜ ì¶”ì²œ ë²ˆí˜¸</div>
            <div class="pred-desc">
                ì—­ëŒ€ ë‹¹ì²¨ ë°ì´í„°ì˜ ì¶œí˜„ ë¹ˆë„ì™€ ìµœê·¼ íŠ¸ë Œë“œë¥¼ í†µê³„ì ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ ìƒì„±ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤.<br>
                ë§¤ì£¼ ì¼ìš”ì¼ì— ìƒˆë¡œìš´ ë²ˆí˜¸ë¡œ ê°±ì‹ ë©ë‹ˆë‹¤.<br>
                ì¶”ì²œë²ˆí˜¸ëŠ” ì‚¬ìš©ìë§ˆë‹¤ ë‹¤ë¥´ê²Œ ìƒì„±ë˜ë©°, ë‹¹ì²¨ì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </div>
            <div id="prediction-sets"></div>

            <!-- ê³µìœ  ë²„íŠ¼ -->
            <div class="share-section">
                <div class="share-title">ë‚´ ì˜ˆì¸¡ ë²ˆí˜¸ ê³µìœ í•˜ê¸°</div>
                <div class="share-buttons">
                    <button class="share-btn share-kakao" onclick="shareKakao()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 3C6.48 3 2 6.58 2 11c0 2.89 1.91 5.43 4.78 6.85-.2.72-.75 2.64-.86 3.05-.14.51.19.5.39.37.16-.11 2.52-1.68 3.46-2.31.63.09 1.28.14 1.94.14 5.52 0 10-3.58 10-8s-4.48-8-10-8z"/>
                        </svg>
                        ì¹´ì¹´ì˜¤í†¡
                    </button>
                    <button class="share-btn share-url" onclick="copyURL()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                        </svg>
                        URL ë³µì‚¬
                    </button>
                    <button class="share-btn share-twitter" onclick="shareTwitter()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                        íŠ¸ìœ„í„°
                    </button>
                </div>
                <div id="share-result" class="share-result"></div>
            </div>
        </div>
    </div>

    <!-- íŒë§¤ì  ì§€ë„ -->
    <div id="tab-stores" class="tab-content">
        <div class="card fade-in">
            <div class="card-header">1ë“± ë°°ì¶œ íŒë§¤ì  ì§€ë„</div>
            <div class="store-summary" id="store-summary"></div>
            <div class="store-filter">
                <select id="store-region-filter" onchange="filterStoresByRegion()">
                    <option value="all">ì „ì²´ ì§€ì—­</option>
                    <option value="ì„œìš¸">ì„œìš¸</option>
                    <option value="ë¶€ì‚°">ë¶€ì‚°</option>
                    <option value="ëŒ€êµ¬">ëŒ€êµ¬</option>
                    <option value="ì¸ì²œ">ì¸ì²œ</option>
                    <option value="ê´‘ì£¼">ê´‘ì£¼</option>
                    <option value="ëŒ€ì „">ëŒ€ì „</option>
                    <option value="ìš¸ì‚°">ìš¸ì‚°</option>
                    <option value="ì„¸ì¢…">ì„¸ì¢…</option>
                    <option value="ê²½ê¸°">ê²½ê¸°</option>
                    <option value="ê°•ì›">ê°•ì›</option>
                    <option value="ì¶©ë¶">ì¶©ë¶</option>
                    <option value="ì¶©ë‚¨">ì¶©ë‚¨</option>
                    <option value="ì „ë¶">ì „ë¶</option>
                    <option value="ì „ë‚¨">ì „ë‚¨</option>
                    <option value="ê²½ë¶">ê²½ë¶</option>
                    <option value="ê²½ë‚¨">ê²½ë‚¨</option>
                    <option value="ì œì£¼">ì œì£¼</option>
                </select>
            </div>
            <div id="store-map" class="store-map"></div>
        </div>
        <div class="card fade-in">
            <div class="card-header">íŒë§¤ì  ìˆœìœ„</div>
            <div id="store-loading" class="loading" style="display:none;">
                <div class="spinner"></div>
                <div class="loading-text">íŒë§¤ì  ë°ì´í„° ìˆ˜ì§‘ ì¤‘...</div>
            </div>
            <div style="overflow-x:auto;">
                <table class="tbl" id="store-table">
                    <thead>
                        <tr>
                            <th>ìˆœìœ„</th>
                            <th>íŒë§¤ì ëª…</th>
                            <th>1ë“± íšŸìˆ˜</th>
                            <th>ì£¼ì†Œ</th>
                        </tr>
                    </thead>
                    <tbody id="store-tbody"></tbody>
                </table>
            </div>
            <div id="store-pagination" class="store-pagination"></div>
        </div>
    </div>

    <!-- í™•ë¥  êµì‹¤ -->
    <div id="tab-probability" class="tab-content">
        <div class="card fade-in">
            <div class="card-header">ë“±ìˆ˜ë³„ ë‹¹ì²¨ í™•ë¥ </div>
            <p class="prob-desc">ë¡œë˜ 6/45ëŠ” 1~45ë²ˆ ì¤‘ 6ê°œë¥¼ ì„ íƒí•˜ê³ , ë³´ë„ˆìŠ¤ ë²ˆí˜¸ 1ê°œê°€ ì¶”ê°€ë¡œ ì¶”ì²¨ë©ë‹ˆë‹¤.</p>

            <div class="prob-cards">
                <div class="prob-card prob-card-1">
                    <div class="prob-card-rank">1ë“±</div>
                    <div class="prob-card-match">6ê°œ ì¼ì¹˜</div>
                    <div class="prob-card-odds">1 / 8,145,060</div>
                    <div class="prob-card-pct">0.0000123%</div>
                </div>
                <div class="prob-card prob-card-2">
                    <div class="prob-card-rank">2ë“±</div>
                    <div class="prob-card-match">5ê°œ + ë³´ë„ˆìŠ¤</div>
                    <div class="prob-card-odds">1 / 1,357,510</div>
                    <div class="prob-card-pct">0.0000737%</div>
                </div>
                <div class="prob-card prob-card-3">
                    <div class="prob-card-rank">3ë“±</div>
                    <div class="prob-card-match">5ê°œ ì¼ì¹˜</div>
                    <div class="prob-card-odds">1 / 35,724</div>
                    <div class="prob-card-pct">0.00280%</div>
                </div>
                <div class="prob-card prob-card-4">
                    <div class="prob-card-rank">4ë“±</div>
                    <div class="prob-card-match">4ê°œ ì¼ì¹˜</div>
                    <div class="prob-card-odds">1 / 733</div>
                    <div class="prob-card-pct">0.136%</div>
                </div>
                <div class="prob-card prob-card-5">
                    <div class="prob-card-rank">5ë“±</div>
                    <div class="prob-card-match">3ê°œ ì¼ì¹˜</div>
                    <div class="prob-card-odds">1 / 45</div>
                    <div class="prob-card-pct">2.22%</div>
                </div>
            </div>

            <div class="prob-total-box">
                <span>ì•„ë¬´ ë“±ìˆ˜ë¼ë„ ë‹¹ì²¨ë  í™•ë¥ </span>
                <strong>ì•½ 1 / 42 (2.38%)</strong>
            </div>
        </div>

        <div class="card fade-in">
            <div class="card-header">1ë“± í™•ë¥ ì€ ì–´ë–»ê²Œ ê³„ì‚°í• ê¹Œ?</div>
            <div class="page-content">
                <p>45ê°œ ë²ˆí˜¸ ì¤‘ 6ê°œë¥¼ ë½‘ëŠ” ì¡°í•©ì˜ ìˆ˜:</p>
                <div class="prob-formula">
                    <sub>45</sub>C<sub>6</sub> = 45! / (6! Ã— 39!) = <strong>8,145,060</strong>ê°€ì§€
                </div>
                <p>ì´ ì¤‘ ì •í™•íˆ 1ê°€ì§€ë§Œ 1ë“±ì´ë¯€ë¡œ í™•ë¥ ì€ <strong>1/8,145,060</strong> ì…ë‹ˆë‹¤.</p>
                <p style="margin-top:16px;">2ë“±ì€ ë³´ë„ˆìŠ¤ ë²ˆí˜¸ê¹Œì§€ ë§ì¶°ì•¼ í•˜ë¯€ë¡œ:</p>
                <div class="prob-formula">
                    6ê°€ì§€(ë¹ ì§„ ë²ˆí˜¸ ì„ íƒ) Ã— 1(ë³´ë„ˆìŠ¤) = 6ê°€ì§€ â†’ <strong>1/1,357,510</strong>
                </div>
            </div>
        </div>

        <div class="card fade-in">
            <div class="card-header">ë¡œë˜ 1ë“± vs ì¼ìƒ ì† í™•ë¥ </div>
            <p class="prob-desc">1ë“± ë‹¹ì²¨ í™•ë¥  1/8,145,060ì´ ì–¼ë§ˆë‚˜ ì–´ë ¤ìš´ ìˆ«ìì¸ì§€ ë¹„êµí•´ë´…ë‹ˆë‹¤.</p>
            <div class="prob-compare-list">
                <div class="prob-compare-item">
                    <div class="prob-compare-icon">âš¡</div>
                    <div class="prob-compare-body">
                        <div class="prob-compare-title">ë²¼ë½ì— ë§ì„ í™•ë¥ </div>
                        <div class="prob-compare-odds">ì•½ 1 / 1,200,000</div>
                        <div class="prob-compare-note">ë¡œë˜ 1ë“±ë³´ë‹¤ <strong>ì•½ 7ë°°</strong> ë” ì‰¬ì›€</div>
                    </div>
                </div>
                <div class="prob-compare-item">
                    <div class="prob-compare-icon">ğŸŒ </div>
                    <div class="prob-compare-body">
                        <div class="prob-compare-title">ìœ ì„±ì— ë§ì„ í™•ë¥ </div>
                        <div class="prob-compare-odds">ì•½ 1 / 1,600,000</div>
                        <div class="prob-compare-note">ë¡œë˜ 1ë“±ë³´ë‹¤ <strong>ì•½ 5ë°°</strong> ë” ì‰¬ì›€</div>
                    </div>
                </div>
                <div class="prob-compare-item">
                    <div class="prob-compare-icon">ğŸ¯</div>
                    <div class="prob-compare-body">
                        <div class="prob-compare-title">ë™ì „ 23ë²ˆ ì—°ì† ì•ë©´</div>
                        <div class="prob-compare-odds">ì•½ 1 / 8,388,608</div>
                        <div class="prob-compare-note">ë¡œë˜ 1ë“±ê³¼ <strong>ê±°ì˜ ê°™ì€</strong> í™•ë¥ </div>
                    </div>
                </div>
                <div class="prob-compare-item">
                    <div class="prob-compare-icon">ğŸ‘¶</div>
                    <div class="prob-compare-body">
                        <div class="prob-compare-title">ë„¤ìŒë‘¥ì´ ì¶œì‚° í™•ë¥ </div>
                        <div class="prob-compare-odds">ì•½ 1 / 15,000,000</div>
                        <div class="prob-compare-note">ë¡œë˜ 1ë“±ë³´ë‹¤ <strong>ì•½ 2ë°°</strong> ë” ì–´ë ¤ì›€</div>
                    </div>
                </div>
                <div class="prob-compare-item">
                    <div class="prob-compare-icon">ğŸ€</div>
                    <div class="prob-compare-body">
                        <div class="prob-compare-title">í•˜í”„ë¼ì¸ ìŠ› ì„±ê³µ</div>
                        <div class="prob-compare-odds">ì•½ 1 / 50</div>
                        <div class="prob-compare-note">ë¡œë˜ 1ë“±ë³´ë‹¤ <strong>ì•½ 16ë§Œë°°</strong> ë” ì‰¬ì›€</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card fade-in">
            <div class="card-header">ë¡œë˜ì˜ ê¸°ëŒ€ê°’</div>
            <div class="page-content">
                <p><strong>ê¸°ëŒ€ê°’</strong>ì´ë€, í•œ ì¥ì„ ìƒ€ì„ ë•Œ í‰ê· ì ìœ¼ë¡œ ëŒë ¤ë°›ì„ ìˆ˜ ìˆëŠ” ê¸ˆì•¡ì…ë‹ˆë‹¤.</p>
                <table class="tbl" style="margin:16px 0;">
                    <thead>
                        <tr>
                            <th>ë“±ìˆ˜</th>
                            <th>í‰ê·  ë‹¹ì²¨ê¸ˆ</th>
                            <th>í™•ë¥ </th>
                            <th style="text-align:right;">ê¸°ëŒ€ê°’</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>1ë“±</td><td>ì•½ 20ì–µì›</td><td>1/8,145,060</td><td style="text-align:right;">ì•½ 246ì›</td></tr>
                        <tr><td>2ë“±</td><td>ì•½ 5,000ë§Œì›</td><td>1/1,357,510</td><td style="text-align:right;">ì•½ 37ì›</td></tr>
                        <tr><td>3ë“±</td><td>ì•½ 150ë§Œì›</td><td>1/35,724</td><td style="text-align:right;">ì•½ 42ì›</td></tr>
                        <tr><td>4ë“±</td><td>50,000ì›</td><td>1/733</td><td style="text-align:right;">ì•½ 68ì›</td></tr>
                        <tr><td>5ë“±</td><td>5,000ì›</td><td>1/45</td><td style="text-align:right;">ì•½ 111ì›</td></tr>
                        <tr style="border-top:2px solid var(--accent);background:linear-gradient(135deg,rgba(0,113,227,0.05),rgba(175,82,222,0.05));">
                            <td colspan="3"><strong>ì´ ê¸°ëŒ€ê°’ í•©ê³„</strong></td>
                            <td style="text-align:right;"><strong style="font-size:16px;color:var(--accent);">ì•½ 504ì›</strong></td>
                        </tr>
                    </tbody>
                </table>

                <div class="prob-ev-summary">
                    <div class="prob-ev-item">
                        <div class="prob-ev-label">ë¡œë˜ 1ì¥ ê°€ê²©</div>
                        <div class="prob-ev-value">1,000ì›</div>
                    </div>
                    <div class="prob-ev-item">
                        <div class="prob-ev-label">í‰ê·  ê¸°ëŒ€ê°’</div>
                        <div class="prob-ev-value" style="color:var(--red);">ì•½ 504ì›</div>
                    </div>
                    <div class="prob-ev-item">
                        <div class="prob-ev-label">ê¸°ëŒ€ ìˆ˜ìµë¥ </div>
                        <div class="prob-ev-value" style="color:var(--red);">ì•½ -49.6%</div>
                    </div>
                </div>

                <p>í‰ê· ì ìœ¼ë¡œ 1,000ì›ì§œë¦¬ ë¡œë˜ 1ì¥ì„ ì‚¬ë©´ <strong>ì•½ 504ì›</strong>ì„ ëŒë ¤ë°›ëŠ” ì…ˆì…ë‹ˆë‹¤.</p>
            </div>
        </div>

        <div class="card fade-in">
            <div class="card-header">ë§¤ì£¼ ì‚¬ë©´ 1ë“±ì— ì–¸ì œ ë‹¹ì²¨ë ê¹Œ?</div>
            <div class="page-content">
                <p>ë§¤ì£¼ ë¡œë˜ 1ì¥(1,000ì›)ì„ ì‚°ë‹¤ê³  ê°€ì •í•´ë´…ë‹ˆë‹¤.</p>
                <div class="prob-timeline">
                    <div class="prob-timeline-item">
                        <div class="prob-timeline-period">1ë…„</div>
                        <div class="prob-timeline-detail">
                            <div>52ì¥ êµ¬ë§¤ Â· 52,000ì› íˆ¬ì</div>
                            <div class="prob-timeline-chance">1ë“± í™•ë¥ : <strong>0.000639%</strong></div>
                        </div>
                    </div>
                    <div class="prob-timeline-item">
                        <div class="prob-timeline-period">10ë…„</div>
                        <div class="prob-timeline-detail">
                            <div>520ì¥ êµ¬ë§¤ Â· 520,000ì› íˆ¬ì</div>
                            <div class="prob-timeline-chance">1ë“± í™•ë¥ : <strong>0.00638%</strong></div>
                        </div>
                    </div>
                    <div class="prob-timeline-item">
                        <div class="prob-timeline-period">100ë…„</div>
                        <div class="prob-timeline-detail">
                            <div>5,200ì¥ êµ¬ë§¤ Â· 5,200,000ì› íˆ¬ì</div>
                            <div class="prob-timeline-chance">1ë“± í™•ë¥ : <strong>0.0638%</strong></div>
                        </div>
                    </div>
                    <div class="prob-timeline-item prob-timeline-highlight">
                        <div class="prob-timeline-period">156,636ë…„</div>
                        <div class="prob-timeline-detail">
                            <div>8,145,060ì¥ êµ¬ë§¤ Â· ì•½ 81ì–µì› íˆ¬ì</div>
                            <div class="prob-timeline-chance">1ë“± í™•ë¥ : <strong>ì•½ 63.2%</strong> (í†µê³„ì  ê¸°ëŒ€)</div>
                        </div>
                    </div>
                </div>
                <p style="margin-top:16px;">í†µê³„ì ìœ¼ë¡œ 1ë“±ì— í•œ ë²ˆ ë‹¹ì²¨ë˜ë ¤ë©´ ë§¤ì£¼ 1ì¥ì”© <strong>ì•½ 15ë§Œ 6ì²œë…„</strong>ì„ ì‚¬ì•¼ í•©ë‹ˆë‹¤.</p>
            </div>
        </div>

        <div class="card fade-in">
            <div class="card-header">ì•Œì•„ë‘ë©´ ì¢‹ì€ ë¡œë˜ ìƒì‹</div>
            <div class="page-content">
                <div class="prob-tips">
                    <div class="prob-tip">
                        <div class="prob-tip-q">ìë™ vs ìˆ˜ë™, ë‹¹ì²¨ í™•ë¥ ì´ ë‹¤ë¥¸ê°€ìš”?</div>
                        <div class="prob-tip-a">ì•„ë‹™ë‹ˆë‹¤. ìë™ì´ë“  ìˆ˜ë™ì´ë“  ì–´ë–¤ ë²ˆí˜¸ ì¡°í•©ì´ë“  <strong>í™•ë¥ ì€ ë™ì¼í•˜ê²Œ 1/8,145,060</strong>ì…ë‹ˆë‹¤.</div>
                    </div>
                    <div class="prob-tip">
                        <div class="prob-tip-q">ê°™ì€ ë²ˆí˜¸ë¥¼ ë§¤ì£¼ ì‚¬ë©´ ìœ ë¦¬í•œê°€ìš”?</div>
                        <div class="prob-tip-a">ì•„ë‹™ë‹ˆë‹¤. ë§¤ ì¶”ì²¨ì€ <strong>ë…ë¦½ ì‚¬ê±´</strong>ì´ë¯€ë¡œ, ì´ì „ì— ì–´ë–¤ ë²ˆí˜¸ë¥¼ ê³¨ëëŠ”ì§€ì™€ ìƒê´€ì—†ì´ ë§¤íšŒ í™•ë¥ ì€ ë™ì¼í•©ë‹ˆë‹¤.</div>
                    </div>
                    <div class="prob-tip">
                        <div class="prob-tip-q">ë§ì´ ë‚˜ì˜¨ ë²ˆí˜¸ë¥¼ ê³ ë¥´ë©´ ìœ ë¦¬í•œê°€ìš”?</div>
                        <div class="prob-tip-a">ì•„ë‹™ë‹ˆë‹¤. ê³¼ê±° ì¶œí˜„ ë¹ˆë„ëŠ” ë¯¸ë˜ ì¶”ì²¨ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¡œë˜ ì¶”ì²¨ê¸°ëŠ” ë§¤íšŒ <strong>ì™„ì „í•œ ë¬´ì‘ìœ„</strong>ë¡œ ì‘ë™í•©ë‹ˆë‹¤.</div>
                    </div>
                    <div class="prob-tip">
                        <div class="prob-tip-q">1ë“± ë‹¹ì²¨ê¸ˆì„ ë†’ì´ë ¤ë©´?</div>
                        <div class="prob-tip-a">ë‹¤ë¥¸ ì‚¬ëŒì´ ì˜ ì„ íƒí•˜ì§€ ì•ŠëŠ” ë²ˆí˜¸ë¥¼ ê³ ë¥´ë©´, 1ë“±ì´ ëì„ ë•Œ ë‹¹ì²¨ê¸ˆì„ <strong>ë‚˜ëˆ„ëŠ” ì¸ì›ì´ ì¤„ì–´</strong> ì‹¤ìˆ˜ë ¹ì•¡ì´ ì»¤ì§‘ë‹ˆë‹¤.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    </div><!-- container ë‹«ê¸° -->

    <!-- ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” ê´‘ê³  -->
    <aside class="sidebar-ad sidebar-ad-right">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-3398247421662455"
             data-ad-slot="RIGHT_AD_SLOT"
             data-ad-format="vertical"
             data-full-width-responsive="false"></ins>
        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
    </aside>
</div><!-- layout-wrapper ë‹«ê¸° -->
{% endblock %}

{% block scripts %}
<script>
let appData = null;
let currentPage = 1;
let charts = {};

function getBallClass(n) {
    if (n <= 10) return 'ball-1';
    if (n <= 20) return 'ball-2';
    if (n <= 30) return 'ball-3';
    if (n <= 40) return 'ball-4';
    return 'ball-5';
}

function renderBall(n, size = '', extra = '') {
    const sc = size === 'lg' ? 'ball-lg' : size === 'sm' ? 'ball-sm' : '';
    return `<span class="ball ${getBallClass(n)} ${sc} ${extra}">${n}</span>`;
}

function formatMoney(val) {
    if (!val) return '-';
    const b = val / 100000000;
    return b >= 1 ? b.toFixed(0) + 'ì–µ' : (val / 10000).toFixed(0) + 'ë§Œ';
}

// Tabs
document.querySelectorAll('.tab-item').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
    });
});

// Load
async function loadData() {
    document.getElementById('loading').style.display = 'flex';
    try {
        const resp = await fetch('/api/data');
        if (resp.status === 202) { pollStatus(); return; }
        appData = await resp.json();
        if (appData.error) { pollStatus(); return; }
        renderAll();
    } catch (e) {
        document.getElementById('loading').innerHTML =
            '<div class="loading-text">ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
    }
}

async function pollStatus() {
    const resp = await fetch('/api/status');
    const s = await resp.json();
    if (s.ready || s.cached_count > 100) { loadData(); return; }
    const pct = s.total > 0 ? Math.round(s.progress / s.total * 100) : 0;
    document.getElementById('loading').innerHTML = `
        <div class="spinner"></div>
        <div class="loading-text">ë°ì´í„° ìˆ˜ì§‘ ì¤‘ ${pct}%</div>
        <div style="width:200px;height:4px;background:var(--border);border-radius:2px;overflow:hidden;">
            <div style="width:${pct}%;height:100%;background:var(--text-2);transition:width 0.3s;"></div>
        </div>`;
    setTimeout(pollStatus, 2000);
}

function renderAll() {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('tab-checker').classList.add('active');
    renderCheckerInfo();
    renderDrawsTable();
    renderHotCold();
    renderRecentFreqChart();
    renderRangeChart();
    renderOddEven();
    renderConsecutive();
    renderSumStats();
    loadOrCreatePredictions();
}

// Hot/Cold
function renderHotCold() {
    const render = (nums, id) => {
        document.getElementById(id).innerHTML = nums.map(item => `
            <div class="num-item">
                ${renderBall(item.number)}
                <span class="num-count">${item.count}</span>
            </div>`).join('');
    };
    render(appData.analysis.hot_numbers, 'hot-numbers');
    render(appData.analysis.cold_numbers, 'cold-numbers');
}

// Draws Table
function renderDrawsTable(page = 1, search = '') {
    currentPage = page;
    fetch('/api/draws?' + new URLSearchParams({ page, per_page: 20, search }))
        .then(r => r.json())
        .then(data => {
            document.getElementById('draws-tbody').innerHTML = data.draws.map(d => `
                <tr>
                    <td><span class="draw-no">${d.draw_no}</span></td>
                    <td><span class="draw-date">${d.date}</span></td>
                    <td>
                        <div class="balls-row">
                            ${d.numbers.map(n => renderBall(n, 'sm')).join('')}
                        </div>
                    </td>
                    <td>${renderBall(d.bonus, 'sm', 'ball-bonus')}</td>
                    <td><span class="prize">${formatMoney(d.prize_1st)}</span></td>
                </tr>`).join('');
            renderPagination(data);
        });
}

function renderPagination(data) {
    const { page, total_pages } = data;
    let h = '';
    h += `<button class="pg-btn" onclick="renderDrawsTable(${page-1})" ${page===1?'disabled':''}>&lsaquo;</button>`;
    const s = Math.max(1, page - 2), e = Math.min(total_pages, page + 2);
    for (let i = s; i <= e; i++)
        h += `<button class="pg-btn ${i===page?'active':''}" onclick="renderDrawsTable(${i})">${i}</button>`;
    h += `<span class="pg-info">${page} / ${total_pages}</span>`;
    h += `<button class="pg-btn" onclick="renderDrawsTable(${page+1})" ${page===total_pages?'disabled':''}>&rsaquo;</button>`;
    document.getElementById('pagination').innerHTML = h;
}

function searchDraws() { renderDrawsTable(1, document.getElementById('search-draw').value); }

// Charts
const chartColors = n => {
    if (n <= 10) return '#ff9f0a';
    if (n <= 20) return '#64d2ff';
    if (n <= 30) return '#ff453a';
    if (n <= 40) return '#bf5af2';
    return '#30d158';
};

function renderRecentFreqChart() {
    const ctx = document.getElementById('recentFreqChart');
    if (charts['recent']) charts['recent'].destroy();
    const freq = appData.analysis.recent_frequency;
    const labels = Object.keys(freq).map(Number);
    charts['recent'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [{ data: Object.values(freq), backgroundColor: labels.map(n => chartColors(n) + 'aa'), borderRadius: 3 }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.04)' } } }
        }
    });
}

function renderRangeChart() {
    const ctx = document.getElementById('rangeChart');
    if (charts['range']) charts['range'].destroy();
    const r = appData.analysis.range_analysis;
    charts['range'] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(r),
            datasets: [{ data: Object.values(r), backgroundColor: ['#ff9f0a','#64d2ff','#ff453a','#bf5af2','#30d158'], borderWidth: 0 }]
        },
        options: {
            responsive: true, maintainAspectRatio: false, cutout: '65%',
            plugins: {
                legend: { position: 'bottom', labels: { padding: 16, usePointStyle: true, pointStyle: 'circle', font: { size: 12 } } },
                tooltip: { callbacks: { label: c => `${c.label}: ${c.parsed}%` } }
            }
        }
    });
}

// Odd/Even
function renderOddEven() {
    const oe = appData.analysis.odd_even;
    const op = ((oe.avg_odd/6)*100).toFixed(1), ep = ((oe.avg_even/6)*100).toFixed(1);
    const tags = oe.combos.slice(0,6).map(c =>
        `<span class="tag">${c.combo.replace(':','í™€ ')}ì§ &middot; ${c.count}íšŒ</span>`).join('');
    document.getElementById('odd-even-stats').innerHTML = `
        <div style="margin-bottom:16px;">
            <div style="font-size:14px;margin-bottom:8px;">í‰ê·  í™€ <strong>${oe.avg_odd}</strong> / ì§ <strong>${oe.avg_even}</strong></div>
            <div class="bar-track">
                <div class="bar-seg bar-odd" style="width:${op}%">${op}%</div>
                <div class="bar-seg bar-even" style="width:${ep}%">${ep}%</div>
            </div>
        </div>
        <div style="font-size:12px;color:var(--text-3);margin-bottom:8px;">ì¡°í•©ë³„ ë¹ˆë„</div>
        ${tags}`;
}

// Consecutive
function renderConsecutive() {
    const c = appData.analysis.consecutive;
    document.getElementById('consecutive-stats').innerHTML = `
        <div class="stat-block">
            <div class="stat-num">${c.percentage}%</div>
            <div class="stat-label">ì—°ì†ë²ˆí˜¸ í¬í•¨ ë¹„ìœ¨</div>
            <div style="font-size:13px;color:var(--text-2);margin-top:12px;">
                ${c.total_draws}íšŒ ì¤‘ ${c.consecutive_draws}íšŒ
            </div>
        </div>`;
}

// Sum
function renderSumStats() {
    const s = appData.analysis.sum_stats;
    document.getElementById('sum-stats').innerHTML = `
        <div class="stat-block">
            <div class="stat-num">${s.avg}</div>
            <div class="stat-label">6ê°œ ë²ˆí˜¸ í•©ê³„ í‰ê· </div>
            <div style="display:flex;justify-content:center;gap:24px;margin-top:12px;font-size:13px;color:var(--text-2);">
                <span>ìµœì†Œ ${s.min}</span>
                <span>ìµœëŒ€ ${s.max}</span>
                <span>í‘œì¤€í¸ì°¨ ${s.std}</span>
            </div>
        </div>`;
}

// Predictions
function getSundayKey() {
    const now = new Date();
    const day = now.getDay();
    const diff = day === 0 ? 0 : 7 - day;
    const sun = new Date(now);
    sun.setDate(now.getDate() + diff);
    return sun.toISOString().split('T')[0];
}

function loadOrCreatePredictions() {
    const nextDraw = appData.analysis.latest_draw.draw_no + 1;
    const key = getSundayKey();
    const stored = localStorage.getItem('lotto_predictions');
    if (stored) {
        const p = JSON.parse(stored);
        if (p.week === key) { renderPredictions(p.predictions, p.draw_no || nextDraw); return; }
    }
    fetch('/api/predict').then(r => r.json()).then(data => {
        localStorage.setItem('lotto_predictions', JSON.stringify({ week: key, draw_no: nextDraw, predictions: data.predictions }));
        renderPredictions(data.predictions, nextDraw);
    });
}

function renderPredictions(predictions, nextDraw) {
    document.getElementById('prediction-sets').innerHTML =
        `<div style="font-size:13px;color:rgba(255,255,255,0.35);margin-bottom:16px;">ì œ ${nextDraw}íšŒ</div>` +
        predictions.map((pred, i) => `
            <div class="pred-row">
                <span class="pred-label">SET ${i+1}</span>
                <div class="balls-row">${pred.map(n => renderBall(n)).join('')}</div>
            </div>`).join('');
}

// Checker
function renderCheckerInfo() {
    const draws = appData.draws;
    const latest = draws[draws.length - 1];
    document.getElementById('checker-latest-info').innerHTML =
        `<span>ì œ ${latest.draw_no}íšŒ</span><span>${latest.date}</span>`;
}

function clearChecker() {
    for (let i = 1; i <= 6; i++) document.getElementById('cn' + i).value = '';
    document.getElementById('checker-result').style.display = 'none';
}

// ì…ë ¥ì¹¸ ìë™ ì´ë™
document.querySelectorAll('.checker-num').forEach((input, idx) => {
    input.addEventListener('input', () => {
        let v = parseInt(input.value);
        if (v > 45) input.value = 45;
        if (v < 1 && input.value !== '') input.value = 1;
        if (input.value.length >= 2 && idx < 5) {
            document.getElementById('cn' + (idx + 2)).focus();
        }
    });
    input.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
            e.preventDefault();
            if (idx < 5) document.getElementById('cn' + (idx + 2)).focus();
            else checkMyNumbers();
        }
    });
});

function checkMyNumbers() {
    if (!appData) return;
    const myNums = [];
    for (let i = 1; i <= 6; i++) {
        const v = parseInt(document.getElementById('cn' + i).value);
        if (isNaN(v) || v < 1 || v > 45) {
            document.getElementById('cn' + i).focus();
            document.getElementById('cn' + i).classList.add('checker-num-error');
            setTimeout(() => document.getElementById('cn' + i).classList.remove('checker-num-error'), 800);
            return;
        }
        if (myNums.includes(v)) {
            document.getElementById('cn' + i).focus();
            document.getElementById('cn' + i).classList.add('checker-num-error');
            setTimeout(() => document.getElementById('cn' + i).classList.remove('checker-num-error'), 800);
            return;
        }
        myNums.push(v);
    }

    const draws = appData.draws;
    const latest = draws[draws.length - 1];
    const matched = myNums.filter(n => latest.numbers.includes(n));
    const bonusMatch = myNums.includes(latest.bonus);

    let rank = 0;
    if (matched.length === 6) rank = 1;
    else if (matched.length === 5 && bonusMatch) rank = 2;
    else if (matched.length === 5) rank = 3;
    else if (matched.length === 4) rank = 4;
    else if (matched.length === 3) rank = 5;

    const rankNames = { 1: '1ë“±', 2: '2ë“±', 3: '3ë“±', 4: '4ë“±', 5: '5ë“±' };
    const rankColors = { 1: '#ff3b30', 2: '#ff9f0a', 3: '#af52de', 4: '#0071e3', 5: '#34c759' };

    const resultDiv = document.getElementById('checker-result');
    resultDiv.style.display = 'block';
    const summaryDiv = document.getElementById('checker-summary');

    // ë‹¹ì²¨ë²ˆí˜¸ í‘œì‹œ (ì¼ì¹˜í•˜ë©´ ë°ê²Œ, ë¶ˆì¼ì¹˜í•˜ë©´ íë¦¬ê²Œ)
    const drawBalls = latest.numbers.map(n => {
        const isMatch = matched.includes(n);
        return `<span class="ball ${getBallClass(n)} ${isMatch ? '' : 'ball-dim'}">${n}</span>`;
    }).join('');
    const bonusBall = `<span class="ball ${getBallClass(latest.bonus)} ${bonusMatch ? '' : 'ball-dim'} ball-bonus">${latest.bonus}</span>`;

    const drawSection = `
        <div class="checker-draw-row">
            <div class="checker-draw-label">ì œ ${latest.draw_no}íšŒ ë‹¹ì²¨ë²ˆí˜¸</div>
            <div class="balls-row" style="justify-content:center;gap:10px;">
                ${drawBalls}
                <span class="balls-divider"></span>
                ${bonusBall}
            </div>
        </div>`;

    if (rank === 0) {
        summaryDiv.innerHTML = `
            <div class="checker-result-hero">
                <div class="checker-my-balls">${myNums.map(n => renderBall(n, 'lg')).join('')}</div>
                <div class="checker-result-msg">ë‚™ì²¨</div>
                <div class="checker-result-sub">${latest.date} ì¶”ì²¨ / ì¼ì¹˜ë²ˆí˜¸ ${matched.length}ê°œ</div>
                ${drawSection}
            </div>`;
    } else {
        summaryDiv.innerHTML = `
            <div class="checker-result-hero">
                <div class="checker-my-balls">${myNums.map(n => renderBall(n, 'lg')).join('')}</div>
                <div class="checker-result-rank" style="color:${rankColors[rank]}">${rankNames[rank]}</div>
                <div class="checker-result-sub">${latest.date} ì¶”ì²¨ / ì¼ì¹˜ë²ˆí˜¸ ${matched.length}ê°œ${bonusMatch ? ' + ë³´ë„ˆìŠ¤' : ''}</div>
                ${drawSection}
            </div>`;
    }

    resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Refresh
async function refreshData(e) {
    const btn = e.target;
    btn.textContent = 'ê°±ì‹  ì¤‘...';
    btn.disabled = true;
    await fetch('/api/refresh');
    await loadData();
    btn.textContent = 'ë°ì´í„° ê°±ì‹ ';
    btn.disabled = false;
    // íƒ­ UIë„ ë‹¹ì²¨ë²ˆí˜¸ë¡œ ì „í™˜
    document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector('.tab-item[data-tab="checker"]').classList.add('active');
    document.getElementById('tab-checker').classList.add('active');
}

// Share Functions
function showShareResult(message, success = true) {
    const resultDiv = document.getElementById('share-result');
    resultDiv.textContent = message;
    resultDiv.className = `share-result show ${success ? 'success' : 'error'}`;
    setTimeout(() => {
        resultDiv.classList.remove('show');
    }, 3000);
}

function shareKakao() {
    if (!appData || !appData.analysis || !appData.analysis.predictions) {
        showShareResult('ì˜ˆì¸¡ ë²ˆí˜¸ë¥¼ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”', false);
        return;
    }

    // Kakao SDK ì´ˆê¸°í™” (JavaScript Key í•„ìš”)
    if (typeof Kakao !== 'undefined' && !Kakao.isInitialized()) {
        // TODO: Kakao JavaScript Keyë¡œ êµì²´ í•„ìš”
        // Kakao.init('YOUR_JAVASCRIPT_KEY');
    }

    const predictions = appData.analysis.predictions;
    const nextDraw = appData.analysis.latest_draw.draw_no + 1;
    const predictionsText = predictions.slice(0, 3).map((p, i) =>
        `SET ${i+1}: ${p.join(', ')}`
    ).join('\\n');

    const shareText = `ğŸ° Lotto Lab í†µê³„ ë¶„ì„ ì¶”ì²œ ë²ˆí˜¸\\nì œ ${nextDraw}íšŒ\\n\\n${predictionsText}\\n\\nì—­ëŒ€ ë°ì´í„° ê¸°ë°˜ í†µê³„ ë¶„ì„`;

    // ì¹´ì¹´ì˜¤í†¡ ê³µìœ  (SDK ì„¤ì • í•„ìš”)
    if (typeof Kakao !== 'undefined' && Kakao.isInitialized()) {
        Kakao.Share.sendDefault({
            objectType: 'text',
            text: shareText,
            link: {
                mobileWebUrl: window.location.href,
                webUrl: window.location.href,
            }
        });
    } else {
        // SDK ë¯¸ì„¤ì • ì‹œ í…ìŠ¤íŠ¸ ë³µì‚¬
        navigator.clipboard.writeText(shareText).then(() => {
            showShareResult('ì˜ˆì¸¡ ë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ì¹´ì¹´ì˜¤í†¡ì— ë¶™ì—¬ë„£ê¸°í•˜ì„¸ìš” ğŸ“‹');
        }).catch(() => {
            showShareResult('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', false);
        });
    }
}

function copyURL() {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => {
        showShareResult('URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“‹');
    }).catch(() => {
        showShareResult('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', false);
    });
}

function shareTwitter() {
    if (!appData || !appData.analysis || !appData.analysis.predictions) {
        showShareResult('ì˜ˆì¸¡ ë²ˆí˜¸ë¥¼ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”', false);
        return;
    }

    const predictions = appData.analysis.predictions;
    const nextDraw = appData.analysis.latest_draw.draw_no + 1;
    const predictionsText = predictions.slice(0, 2).map((p, i) =>
        `SET ${i+1}: ${p.join(', ')}`
    ).join('\\n');

    const shareText = `ğŸ° Lotto Lab í†µê³„ ë¶„ì„ ì¶”ì²œ ë²ˆí˜¸\\nì œ ${nextDraw}íšŒ\\n${predictionsText}\\n\\nì—­ëŒ€ ë°ì´í„° ê¸°ë°˜ í†µê³„ ë¶„ì„`;
    const url = window.location.href;
    const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(url)}`;

    window.open(twitterUrl, '_blank', 'width=550,height=420');
}

// â”€â”€ íŒë§¤ì  ì§€ë„ â”€â”€
let storeMap = null;
let storeMarkers = null;
let storeData = [];
let storesLoaded = false;

// íƒ­ ì „í™˜ ì‹œ íŒë§¤ì  ë°ì´í„° ë¡œë“œ
document.querySelectorAll('.tab-item').forEach(tab => {
    tab.addEventListener('click', () => {
        if (tab.dataset.tab === 'stores' && !storesLoaded) {
            loadStores();
        }
        // ì§€ë„ ì‚¬ì´ì¦ˆ ê°±ì‹  (íƒ­ ì „í™˜ í›„ ì§€ë„ê°€ ì˜¬ë°”ë¥´ê²Œ ë Œë”ë§ë˜ë„ë¡)
        if (tab.dataset.tab === 'stores' && storeMap) {
            setTimeout(() => storeMap.invalidateSize(), 100);
        }
    });
});

function initStoreMap() {
    if (storeMap) return;
    storeMap = L.map('store-map').setView([36.5, 127.5], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        maxZoom: 18,
    }).addTo(storeMap);
    storeMarkers = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
    });
    storeMap.addLayer(storeMarkers);
}

async function loadStores() {
    const loading = document.getElementById('store-loading');
    loading.style.display = 'flex';
    initStoreMap();

    try {
        const resp = await fetch('/api/stores');
        const data = await resp.json();
        storeData = data.stores || [];

        if (storeData.length === 0) {
            document.getElementById('store-summary').innerHTML =
                '<div style="color:var(--text-3);font-size:14px;padding:8px 0;">íŒë§¤ì  ë°ì´í„°ë¥¼ ìˆ˜ì§‘ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>';
            loading.style.display = 'none';
            pollStoreStatus();
            return;
        }

        storesLoaded = true;
        renderStores(storeData);
        loading.style.display = 'none';
    } catch (e) {
        loading.style.display = 'none';
        document.getElementById('store-summary').innerHTML =
            '<div style="color:var(--red);font-size:14px;">íŒë§¤ì  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    }
}

async function pollStoreStatus() {
    try {
        const resp = await fetch('/api/stores');
        const data = await resp.json();
        if (data.stores && data.stores.length > 0) {
            storeData = data.stores;
            storesLoaded = true;
            renderStores(storeData);
            document.getElementById('store-loading').style.display = 'none';
            return;
        }
    } catch (e) {}
    setTimeout(pollStoreStatus, 5000);
}

const STORE_PAGE_SIZE = 10;
let storeCurrentPage = 1;
let storeCurrentList = [];

function renderStores(stores) {
    storeCurrentList = stores;
    storeCurrentPage = 1;

    // ìš”ì•½ ì •ë³´
    const totalWins = stores.reduce((sum, s) => sum + (s.win_count || 0), 0);
    document.getElementById('store-summary').innerHTML = `
        <div class="store-stats">
            <div class="store-stat-item">
                <div class="store-stat-num">${stores.length}</div>
                <div class="store-stat-label">íŒë§¤ì </div>
            </div>
            <div class="store-stat-item">
                <div class="store-stat-num">${totalWins}</div>
                <div class="store-stat-label">ì´ 1ë“± ë°°ì¶œ</div>
            </div>
            <div class="store-stat-item">
                <div class="store-stat-num">${stores.length > 0 ? stores[0].win_count : 0}</div>
                <div class="store-stat-label">ìµœë‹¤ ë°°ì¶œ</div>
            </div>
        </div>`;

    // ì§€ë„ ë§ˆì»¤
    addStoreMarkers(stores);

    // í…Œì´ë¸” (í˜ì´ì§€ë„¤ì´ì…˜)
    renderStorePage(1);
}

function renderStorePage(page) {
    storeCurrentPage = page;
    const stores = storeCurrentList;
    const totalPages = Math.ceil(stores.length / STORE_PAGE_SIZE);
    const start = (page - 1) * STORE_PAGE_SIZE;
    const end = Math.min(start + STORE_PAGE_SIZE, stores.length);
    const pageStores = stores.slice(start, end);

    document.getElementById('store-tbody').innerHTML = pageStores.map((s, i) => {
        const idx = start + i;
        return `<tr class="store-row" onclick="focusStore(${idx})" style="cursor:pointer;">
            <td><span class="store-rank ${idx < 3 ? 'store-rank-top' : ''}">${s.rank || (idx + 1)}</span></td>
            <td><strong>${s.name}</strong></td>
            <td><span class="store-wins">${s.win_count}íšŒ</span></td>
            <td><span class="store-addr">${s.address}</span></td>
        </tr>`;
    }).join('');

    // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
    if (totalPages <= 1) {
        document.getElementById('store-pagination').innerHTML = '';
        return;
    }

    let html = '';
    // ì´ì „ ë²„íŠ¼
    html += `<button class="sp-btn ${page <= 1 ? 'sp-disabled' : ''}" ${page > 1 ? `onclick="renderStorePage(${page - 1})"` : ''}>â€¹</button>`;

    // í˜ì´ì§€ ë²ˆí˜¸
    const maxVisible = 5;
    let startPage = Math.max(1, page - Math.floor(maxVisible / 2));
    let endPage = Math.min(totalPages, startPage + maxVisible - 1);
    if (endPage - startPage + 1 < maxVisible) startPage = Math.max(1, endPage - maxVisible + 1);

    if (startPage > 1) {
        html += `<button class="sp-btn" onclick="renderStorePage(1)">1</button>`;
        if (startPage > 2) html += `<span class="sp-dots">â€¦</span>`;
    }
    for (let p = startPage; p <= endPage; p++) {
        html += `<button class="sp-btn ${p === page ? 'sp-active' : ''}" onclick="renderStorePage(${p})">${p}</button>`;
    }
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) html += `<span class="sp-dots">â€¦</span>`;
        html += `<button class="sp-btn" onclick="renderStorePage(${totalPages})">${totalPages}</button>`;
    }

    // ë‹¤ìŒ ë²„íŠ¼
    html += `<button class="sp-btn ${page >= totalPages ? 'sp-disabled' : ''}" ${page < totalPages ? `onclick="renderStorePage(${page + 1})"` : ''}>â€º</button>`;

    document.getElementById('store-pagination').innerHTML = html;

    // í…Œì´ë¸” ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
    if (page > 1) document.getElementById('store-table').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function addStoreMarkers(stores) {
    if (!storeMarkers) return;
    storeMarkers.clearLayers();

    const goldIcon = L.divIcon({
        className: 'store-marker',
        html: '<div class="store-marker-pin"></div>',
        iconSize: [30, 36],
        iconAnchor: [15, 36],
        popupAnchor: [0, -36],
    });

    stores.forEach((s, i) => {
        if (!s.lat || !s.lng) return;
        const marker = L.marker([s.lat, s.lng], { icon: goldIcon });
        marker.bindPopup(`
            <div class="store-popup">
                <div class="store-popup-rank">${s.rank || (i + 1)}ìœ„</div>
                <div class="store-popup-name">${s.name}</div>
                <div class="store-popup-wins">1ë“± ${s.win_count}íšŒ ë°°ì¶œ</div>
                <div class="store-popup-addr">${s.address}</div>
            </div>
        `);
        storeMarkers.addLayer(marker);
    });
}

function filterStoresByRegion() {
    const region = document.getElementById('store-region-filter').value;
    if (region === 'all') {
        renderStores(storeData);
        storeMap.setView([36.5, 127.5], 7);
    } else {
        const filtered = storeData.filter(s => s.address && s.address.includes(region));
        renderStores(filtered);
        if (filtered.length > 0 && filtered[0].lat && filtered[0].lng) {
            storeMap.setView([filtered[0].lat, filtered[0].lng], 10);
        }
    }
}

function focusStore(index) {
    const stores = document.getElementById('store-region-filter').value === 'all'
        ? storeData
        : storeData.filter(s => s.address && s.address.includes(document.getElementById('store-region-filter').value));
    const store = stores[index];
    if (store && store.lat && store.lng && storeMap) {
        storeMap.setView([store.lat, store.lng], 16);
        // í•´ë‹¹ ë§ˆì»¤ì˜ íŒì—… ì—´ê¸°
        storeMarkers.eachLayer(layer => {
            const latlng = layer.getLatLng();
            if (Math.abs(latlng.lat - store.lat) < 0.0001 && Math.abs(latlng.lng - store.lng) < 0.0001) {
                layer.openPopup();
            }
        });
    }
}

// â”€â”€ ì‹œë®¬ë ˆì´í„° â”€â”€
document.querySelectorAll('.sim-num').forEach((input, idx) => {
    input.addEventListener('input', () => {
        let v = parseInt(input.value);
        if (v > 45) input.value = 45;
        if (v < 1 && input.value !== '') input.value = 1;
        if (input.value.length >= 2 && idx < 5) {
            document.getElementById('sn' + (idx + 2)).focus();
        }
    });
    input.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
            e.preventDefault();
            if (idx < 5) document.getElementById('sn' + (idx + 2)).focus();
            else runSimulation();
        }
    });
});

function randomSimNums() {
    const nums = [];
    while (nums.length < 6) {
        const n = Math.floor(Math.random() * 45) + 1;
        if (!nums.includes(n)) nums.push(n);
    }
    nums.sort((a, b) => a - b);
    for (let i = 0; i < 6; i++) document.getElementById('sn' + (i + 1)).value = nums[i];
}

function clearSim() {
    for (let i = 1; i <= 6; i++) document.getElementById('sn' + i).value = '';
    document.getElementById('sim-result').style.display = 'none';
}

function runSimulation() {
    if (!appData) return;
    const myNums = [];
    for (let i = 1; i <= 6; i++) {
        const v = parseInt(document.getElementById('sn' + i).value);
        if (isNaN(v) || v < 1 || v > 45) {
            document.getElementById('sn' + i).focus();
            document.getElementById('sn' + i).classList.add('sim-num-error');
            setTimeout(() => document.getElementById('sn' + i).classList.remove('sim-num-error'), 800);
            return;
        }
        if (myNums.includes(v)) {
            document.getElementById('sn' + i).focus();
            document.getElementById('sn' + i).classList.add('sim-num-error');
            setTimeout(() => document.getElementById('sn' + i).classList.remove('sim-num-error'), 800);
            return;
        }
        myNums.push(v);
    }

    const draws = appData.draws;
    const totalDraws = draws.length;
    const ticketCost = 1000;
    const totalSpent = totalDraws * ticketCost;
    const rankCounts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
    const rankPrize = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 5000 };
    const matchResults = [];

    draws.forEach(d => {
        const matched = myNums.filter(n => d.numbers.includes(n));
        const bonusMatch = myNums.includes(d.bonus);
        let rank = 0;
        if (matched.length === 6) rank = 1;
        else if (matched.length === 5 && bonusMatch) rank = 2;
        else if (matched.length === 5) rank = 3;
        else if (matched.length === 4) rank = 4;
        else if (matched.length === 3) rank = 5;

        if (rank > 0) {
            rankCounts[rank]++;
            let prize = 0;
            if (rank === 1) prize = d.prize_1st || 2000000000;
            else if (rank === 2) prize = (d.prize_1st || 2000000000) / 4;
            else if (rank === 3) prize = 1500000;
            else if (rank === 4) prize = 50000;
            else prize = 5000;
            matchResults.push({
                draw_no: d.draw_no, date: d.date, numbers: d.numbers, bonus: d.bonus,
                matched: matched, bonusMatch: bonusMatch, rank: rank, prize: prize
            });
        }
    });

    matchResults.sort((a, b) => a.rank - b.rank || a.draw_no - b.draw_no);

    const totalWinnings = matchResults.reduce((sum, r) => sum + r.prize, 0);
    const roi = totalSpent > 0 ? ((totalWinnings / totalSpent) * 100).toFixed(1) : '0.0';

    // ìš”ì•½
    const totalMatches = Object.values(rankCounts).reduce((a, b) => a + b, 0);
    document.getElementById('sim-summary').innerHTML = `
        <div class="stat-num">${totalMatches}íšŒ ë‹¹ì²¨</div>
        <div class="stat-label">ì „ì²´ ${totalDraws}íšŒì°¨ ì¤‘</div>
        <div style="display:flex;justify-content:center;gap:16px;margin-top:12px;font-size:13px;color:var(--text-2);">
            ${Object.entries(rankCounts).filter(([,c]) => c > 0).map(([r,c]) => `<span>${r}ë“±: ${c}íšŒ</span>`).join('')}
        </div>`;

    // ìˆ˜ìµë¥ 
    const profitColor = totalWinnings >= totalSpent ? 'var(--green)' : 'var(--red)';
    document.getElementById('sim-profit').innerHTML = `
        <div class="stat-num" style="color:${profitColor}">${roi}%</div>
        <div class="stat-label">íˆ¬ì ëŒ€ë¹„ ìˆ˜ìµë¥ </div>
        <div style="display:flex;justify-content:center;gap:20px;margin-top:12px;font-size:13px;color:var(--text-2);">
            <span>íˆ¬ì: ${formatMoney(totalSpent)}ì›</span>
            <span>ë‹¹ì²¨ê¸ˆ: ${formatSimMoney(totalWinnings)}</span>
        </div>`;

    // ë“±ìˆ˜ë³„ ë°”
    const maxRankCount = Math.max(...Object.values(rankCounts), 1);
    const rankNames = { 1: '1ë“±', 2: '2ë“±', 3: '3ë“±', 4: '4ë“±', 5: '5ë“±' };
    const rankColors = { 1: '#ff3b30', 2: '#ff9f0a', 3: '#af52de', 4: '#0071e3', 5: '#34c759' };
    document.getElementById('sim-rank-chart').innerHTML = Object.entries(rankCounts).map(([r, c]) => `
        <div class="sim-rank-row">
            <span class="sim-rank-label" style="color:${rankColors[r]}">${rankNames[r]}</span>
            <div class="sim-rank-bar-wrap">
                <div class="sim-rank-bar" style="width:${c > 0 ? Math.max(c / maxRankCount * 100, 3) : 0}%;background:${rankColors[r]}"></div>
            </div>
            <span class="sim-rank-count">${c}íšŒ</span>
        </div>`).join('');

    // ë‹¹ì²¨ ë‚´ì—­ í…Œì´ë¸”
    document.getElementById('sim-match-count').textContent = `${matchResults.length}ê±´`;
    document.getElementById('sim-tbody').innerHTML = matchResults.length > 0
        ? matchResults.slice(0, 100).map(r => `
            <tr>
                <td><span class="draw-no">${r.draw_no}</span></td>
                <td><span class="draw-date">${r.date}</span></td>
                <td>
                    <div class="balls-row">
                        ${r.numbers.map(n => {
                            const isMatch = r.matched.includes(n);
                            return `<span class="ball ball-sm ${getBallClass(n)} ${isMatch ? '' : 'ball-dim'}">${n}</span>`;
                        }).join('')}
                        <span class="balls-divider"></span>
                        ${`<span class="ball ball-sm ${getBallClass(r.bonus)} ${r.bonusMatch ? '' : 'ball-dim'} ball-bonus">${r.bonus}</span>`}
                    </div>
                </td>
                <td><strong>${r.matched.length}ê°œ${r.bonusMatch ? '+B' : ''}</strong></td>
                <td><span style="color:${rankColors[r.rank]};font-weight:700;">${rankNames[r.rank]}</span></td>
            </tr>`).join('')
        : '<tr><td colspan="5" style="text-align:center;color:var(--text-3);padding:40px;">ë‹¹ì²¨ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';

    document.getElementById('sim-result').style.display = 'block';
    document.getElementById('sim-result').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function formatSimMoney(val) {
    if (val >= 100000000) return (val / 100000000).toFixed(1) + 'ì–µì›';
    if (val >= 10000) return (val / 10000).toFixed(0) + 'ë§Œì›';
    return val.toLocaleString() + 'ì›';
}

loadData();
</script>
{% endblock %}
